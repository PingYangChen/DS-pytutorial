---
title: "Linear Models"
format: 
    html:
        html-math-method: mathml
lang: zh-TW
---


## Linear Regression

在開始之前，請確保你安裝了必要的 Python 套件，如 **statsmodels** 和 **scikit-learn**。你可以使用以下命令安裝：
```{python}
#| eval: false
pip install statsmodels scikit-learn 
```

首先，我們需要匯入分析和繪圖所需的套件。
```{python}
# 匯入必要的套件
import os  # 用於作業系統相關的操作
import pandas as pd  # 用於處理和分析資料的資料框架工具
import numpy as np  # 用於數學計算，特別是陣列處理
from matplotlib import pyplot as plt  # 用於繪製圖表
```

接下來，我們會從網路讀取一個 CSV 檔案，這份檔案包含了不同廣告費用（`TV`、`radio`、`newspaper`）對銷售額的影響。這是我們的資料集，會用來進行後續的分析。
```{python}
# 從網路讀取 CSV 檔案並載入至 pandas DataFrame
adv_df = pd.read_csv('https://raw.githubusercontent.com/PingYangChen/DS-pytutorial/refs/heads/main/sample_data/Advertising.csv')
# 顯示資料集的前 5 行
adv_df.head(5)
# 計算資料集的總行數
len(adv_df)
# 儲存資料集中的欄位名稱
adv_var = adv_df.columns
# 顯示 TV、radio 和 newspaper 的統計摘要（不包含第一個欄位）
adv_df[adv_var[1:]].describe()
```

接下來，我們會用 `matplotlib` 繪製圖表，將 `TV`、`radio` 和 `newspaper` 的廣告費用與銷售額進行視覺化分析。這有助於我們理解不同變數之間的關係。
```{python}
#| warning: false
#| fig-align: 'center'
# 建立圖表，設置大小為12x5英吋
fig = plt.figure(figsize=(8, 3))
# 在第一個子圖中繪製 TV 廣告費用與銷售額的關係圖
ax = plt.subplot(1, 3, 1)
ax.plot(adv_df['TV'], adv_df['sales'], marker='.', linestyle='', color='#A00000')  # 繪製散點圖
ax.set_xlabel("TV", fontsize=14)  # 設置X軸標籤
ax.set_ylabel("sales", fontsize=14)  # 設置Y軸標籤
# 在第二個子圖中繪製 radio 廣告費用與銷售額的關係圖
ax = plt.subplot(1, 3, 2)
ax.plot(adv_df['radio'], adv_df['sales'], marker='.', linestyle='', color='#A00000')
ax.set_xlabel("radio", fontsize=14)
ax.set_ylabel("sales", fontsize=14)
# 在第三個子圖中繪製 newspaper 廣告費用與銷售額的關係圖
ax = plt.subplot(1, 3, 3)
ax.plot(adv_df['newspaper'], adv_df['sales'], marker='.', linestyle='', color='#A00000')
ax.set_xlabel("newspaper", fontsize=14)
ax.set_ylabel("sales", fontsize=14)
# 自動調整子圖間的間距
fig.tight_layout()
# 顯示圖表
fig.show()
```

### Statsmodels

現在，我們將使用 **statsmodels** 進行統計建模。首先，將目標變數 `sales` 存儲為變數 `y`。
```{python}
# 匯入 statsmodels 用於統計建模
import statsmodels.api as sm
# 將 'sales' 欄位的值存為目標變數 y
y = adv_df['sales']
```

接下來，我們要進行簡單線性迴歸分析。將 `TV` 廣告費用作為自變數，並嘗試建立一個迴歸模型。
```{python}
# 將 'TV' 欄位的值存為自變數 x1
x1 = adv_df[['TV']]
```

我們將使用 **statsmodels** 進行線性迴歸，並生成模型的摘要，這將告訴我們模型的參數和統計顯著性。
```{python}
# 使用 statsmodels 進行簡單線性迴歸，並建立模型
slr_sm = sm.OLS(y, sm.add_constant(x1)).fit()
# 顯示迴歸模型摘要
slr_sm.summary()
```

我們將繪製一個 Q-Q 圖（Quantile-Quantile plot），用來檢查簡單線性迴歸模型的殘差是否符合常態分佈。如果數據點沿著對角線分佈，則表明殘差符合常態性假設。
```{python}
#| warning: false
#| message: false
#| fig-align: 'center'
# 繪製 Q-Q 圖（Quantile-Quantile plot），用來檢查殘差是否符合常態分佈
fig = sm.qqplot(slr_sm.resid, fit=True, line="45")
fig.show()
```

繪製模型的擬合值與殘差之間的關係圖。這個圖表有助於檢查模型的殘差是否具有隨機分佈。理想情況下，殘差應該均勻分佈在零附近，沒有明顯的模式。
```{python}
#| warning: false
#| message: false
#| fig-align: 'center'
# 繪製模型的擬合值與殘差之間的關係圖，用於檢查模型的殘差
fig = plt.figure(figsize=(5, 5))
ax = plt.subplot(1, 1, 1)
ax.plot(slr_sm.fittedvalues, slr_sm.resid, marker='.', linestyle='', color='#A00000') 
ax.set_xlabel("fittedvalues", fontsize=16)  # 設置X軸標籤為擬合值
ax.set_ylabel("resid", fontsize=16)  # 設置Y軸標籤為殘差
fig.tight_layout()
fig.show()
```

`het_breuschpagan` 是一種檢查異質變異性的檢定方法。如果模型的殘差具有異質變異性，表示模型不符合假設。
檢定結果會包括四個值，依序分別是：Lagrange Multiplier (LM) 檢定統計量、LM p 值、F 檢定統計量、F p 值。
以下結果顯示 F 檢定統計量的 p 值極小，表示殘差具有異質變異性。
```{python}
# 進行 Breusch-Pagan 檢定，用來檢查殘差的異質變異性
# 異質變異性指的是殘差的變異是否隨自變數的變化而改變，如果殘差的變異不一致，模型可能不適合。
slr_bptest = sm.stats.diagnostic.het_breuschpagan(slr_sm.resid, sm.add_constant(x1))
# 輸出 Breusch-Pagan 檢定結果
print(slr_bptest)
```
更多線性模型診斷之統計檢定可參考 [https://www.statsmodels.org/stable/stats.html#module-statsmodels.stats.stattools](https://www.statsmodels.org/stable/stats.html#module-statsmodels.stats.stattools)


上圖看似擬合值與殘差之間存在二次關係，試進行多項式迴歸分析，這裡將 TV 的平方項加入模型，以捕捉自變數和目標變數之間的非線性關係，並繪製 Q-Q 圖以及擬合值與殘差間關係圖來檢查多項式迴歸模型的殘差是否符合模型假設。
```{python}
#| warning: false
#| message: false
#| fig-align: 'center'
# 建立多項式迴歸模型，將自變數擴展為 TV 和 TV 的平方項
from copy import deepcopy
x1s = deepcopy(x1)
x1s['TV2'] = x1['TV']**2
ploy_sm = sm.OLS(np.sqrt(y), sm.add_constant(x1s)).fit()
# 顯示迴歸模型摘要
ploy_sm.summary()
```
```{python}
#| warning: false
#| message: false
#| fig-align: 'center'
# 繪製 Q-Q 圖（Quantile-Quantile plot），用來檢查殘差是否符合常態分佈
fig = sm.qqplot(ploy_sm.resid, fit=True, line="45")
fig.show()
# 繪製多項式模型的擬合值與殘差之間的關係圖
fig = plt.figure(figsize=(5, 5))
ax = plt.subplot(1, 1, 1)
ax.plot(ploy_sm.fittedvalues, ploy_sm.resid, marker='.', linestyle='', color='#A00000') 
ax.set_xlabel("fittedvalues", fontsize=16)  
ax.set_ylabel("resid", fontsize=16)  
fig.tight_layout()
fig.show()
```

現在，我們進行多元線性迴歸。這次我們使用 `TV`、`radio` 和 `newspaper` 廣告費用作為自變數，來預測銷售額。
```{python}
# 進行多元線性迴歸，將 TV、radio 和 newspaper 的廣告費用設為自變數
x = adv_df[['TV', 'radio', 'newspaper']]
```

建立多元線性迴歸模型，並顯示模型的摘要來檢查所有自變數對銷售額的影響。
```{python}
# 建立多元線性迴歸模型
mlr_sm = sm.OLS(y, sm.add_constant(x)).fit()
# 顯示多元線性迴歸模型摘要
mlr_sm.summary()
```

```{python}
#| warning: false
#| message: false
#| fig-align: 'center'
# 繪製多元線性迴歸模型的 Q-Q 圖來檢查殘差是否符合常態分佈
fig = sm.qqplot(mlr_sm.resid, fit=True, line="45")
fig.show()
# 繪製多元線性迴歸模型的擬合值與殘差的關係圖
fig = plt.figure(figsize=(5, 5))
ax = plt.subplot(1, 1, 1)
ax.plot(mlr_sm.fittedvalues, mlr_sm.resid, marker='.', linestyle='', color='#A00000') 
ax.set_xlabel("fittedvalues", fontsize=16)  
ax.set_ylabel("resid", fontsize=16)  
fig.tight_layout()
fig.show()
```

接著，我們嘗試預測一個新的觀察值，假設某個新的廣告費用分配（`TV`: 100000、`radio`: 20000、`newspaper`: 1000），我們將使用模型來預測銷售額。
```{python}
# 預測一個新的觀察值，廣告費用分別是 TV: 100000, radio: 20000, newspaper: 1000
x_new = pd.DataFrame(data=[{'const': 1, 'TV': 100000, 'radio': 20000, 'newspaper': 1000}])
# 使用多元線性迴歸模型進行預測
mlr_sm.predict(x_new)
```

我們可以進一步查看預測的詳細結果，包含預測值的區間範圍等。
```{python}
# 獲取預測的詳細結果
mlr_sm_pred = mlr_sm.get_prediction(x_new)
mlr_sm_pred.summary_frame()
```

```{python}
# 使用 ‘TV’ 和 ‘radio‘ 及交互作用 ‘TV:radio‘ 進行多元迴歸分析
from copy import deepcopy
x2fi = deepcopy(adv_df[['TV', 'radio']])
x2fi['TV:radio'] = x2fi['TV']*x2fi['radio']
lr2fi_sm = sm.OLS(y, sm.add_constant(x2fi)).fit()
lr2fi_sm.summary()
```

```{python}
#| warning: false
#| message: false
#| fig-align: 'center'
# 繪製多元線性迴歸模型的 Q-Q 圖來檢查殘差是否符合常態分佈
fig = sm.qqplot(lr2fi_sm.resid, fit=True, line="45")
fig.show()
# 繪製多元線性迴歸模型的擬合值與殘差的關係圖
fig = plt.figure(figsize=(5, 5))
ax = plt.subplot(1, 1, 1)
ax.plot(lr2fi_sm.fittedvalues, lr2fi_sm.resid, marker='.', linestyle='', color='#A00000') 
ax.set_xlabel("fittedvalues", fontsize=16)  
ax.set_ylabel("resid", fontsize=16)  
fig.tight_layout()
fig.show()
```


```{python}
# 使用 ‘TV’ 和 ‘radio‘ 及交互作用 ‘TV:radio‘ 對 sales**2 進行多元迴歸分析
from copy import deepcopy
x2fi = deepcopy(adv_df[['TV', 'radio']])
x2fi['TV:radio'] = x2fi['TV']*x2fi['radio']
lrsq2fi_sm = sm.OLS(y**2, sm.add_constant(x2fi)).fit()
lrsq2fi_sm.summary()
```

```{python}
#| warning: false
#| message: false
#| fig-align: 'center'
# 繪製多元線性迴歸模型的 Q-Q 圖來檢查殘差是否符合常態分佈
fig = sm.qqplot(lrsq2fi_sm.resid, fit=True, line="45")
fig.show()
# 繪製多元線性迴歸模型的擬合值與殘差的關係圖
fig = plt.figure(figsize=(5, 5))
ax = plt.subplot(1, 1, 1)
ax.plot(lrsq2fi_sm.fittedvalues, lrsq2fi_sm.resid, marker='.', linestyle='', color='#A00000') 
ax.set_xlabel("fittedvalues", fontsize=16)  
ax.set_ylabel("resid", fontsize=16)  
fig.tight_layout()
fig.show()
```


### Scikit-learn
現在，我們切換到使用 **sklearn** 進行線性迴歸，這是另一個流行的迴歸分析工具。首先，匯入 `LinearRegression。`
```{python}
# 使用 sklearn 進行線性迴歸
from sklearn.linear_model import LinearRegression
```

同樣，我們定義自變數和目標變數，這裡我們使用 `TV`、`radio` 和 `newspaper` 廣告費用作為自變數，銷售額作為目標變數。
```{python}
# 自變數為 TV, radio 和 newspaper
x = adv_df[['TV', 'radio', 'newspaper']]
# 目標變數為 sales
y = adv_df['sales']
```

建立線性迴歸模型並進行擬合，這會訓練模型來預測銷售額。
```{python}
#| message: false
# 建立線性迴歸模型
mdl_sk = LinearRegression(fit_intercept=True)
# 使用 sklearn 進行模型擬合
mdl_sk.fit(x, y)
```

我們可以獲取模型的截距和每個變數的係數，這些係數告訴我們每增加一單位廣告費用時，銷售額的變化量。
```{python}
# 獲取截距項
print(mdl_sk.intercept_)
# 獲取迴歸係數
print(mdl_sk.coef_)
```

最後，我們使用 `sklearn` 模型來預測同樣的新觀察值（`TV`: 100000、`radio`: 20000、`newspaper`: 1000），並查看預測結果。
```{python}
#| warning: false
#| message: false
# 預測一個新的觀察值，廣告費用分別是 TV: 100000, radio: 20000, newspaper: 1000
x_new = pd.DataFrame(data=[{'TV': 100000, 'radio': 20000, 'newspaper': 1000}])
# 使用多元線性迴歸模型進行預測
mdl_sk.predict(x_new)
```

